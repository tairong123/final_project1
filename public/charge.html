<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資金管理</title>
</head>
<body>
<h1>資金管理系統</h1>
<form id="charge-form">
    <label for="cost">金額:</label>
    <input type="number" id="cost" name="cost" required>

    <label for="type">項目:</label>
    <select id="type" name="type" required>
        <option value="food">食物</option>
        <option value="clothing">治裝</option>
        <option value="entertainment">娛樂</option>
        <option value="others">其他</option>
    </select>

    <label for="year">年:</label>
    <select id="year" name="year" required>
        <script>
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 10; year--) {
                document.write(`<option value="${year}">${year}</option>`);
            }
        </script>
    </select>

    <label for="month">月:</label>
    <select id="month" name="month" required onchange="updateDays()">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
    </select>

    <label for="day">日:</label>
    <select id="day" name="day" required>
    </select>

    <button type="submit">確認</button>
</form>

<div id="output"></div>

<!-- 表格區域 -->
<h2>記帳紀錄</h2>
<table id="records-table" border="1" style="width: 100%; border-collapse: collapse; text-align: center;">
    <thead>
    <tr>
        <th>金額</th>
        <th>種類</th>
        <th>年</th>
        <th>月</th>
        <th>日</th>
    </tr>
    </thead>
    <tbody>
    <!-- 動態新增的資料會出現在這裡 -->
    </tbody>
</table>

<script>
    document.getElementById('charge-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        console.log('提交的資料:', data);

        fetch('/api/charge_add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then((response) => response.json())
            .then((result) => {
                const output = document.getElementById('output');
                if (result.error) {
                    output.textContent = `錯誤：${result.error}`;
                } else {
                    output.textContent = `成功新增資料，ID: ${result.id}`;
                    addRecordToTable(data); // 將資料新增到表格中
                }
            })
            .catch((error) => {
                console.error('新增資料時發生錯誤：', error);
            });
    });

    function addRecordToTable(record) {
        const tableBody = document.querySelector('#records-table tbody');
        const newRow = document.createElement('tr');

        // 動態創建表格內容
        newRow.innerHTML = `
            <td>${record.cost}</td>
            <td>${record.type}</td>
            <td>${record.year}</td>
            <td>${record.month}</td>
            <td>${record.day}</td>
        `;

        // 將新行加入表格
        tableBody.appendChild(newRow);
    }

    function updateDays() {
        const year = document.getElementById('year').value;
        const month = document.getElementById('month').value;
        const daySelect = document.getElementById('day');

        const daysInMonth = new Date(year, month, 0).getDate();

        daySelect.innerHTML = '';
        for (let day = 1; day <= daysInMonth; day++) {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day;
            daySelect.appendChild(option);
        }
    }

    // Initialize days based on the current month and year
    document.getElementById('year').addEventListener('change', updateDays);
    document.getElementById('month').addEventListener('change', updateDays);
    window.onload = updateDays;

</script>

</body>
</html>
